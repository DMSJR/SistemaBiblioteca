{% extends "templates/base.html" %}
{% block content %}
    <div x-data="livroForm()">
        <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item active">{{ title }}</li>
        </ol>
        <div class="row">
            <div class="col-12">
                <div class="card-header">
                    {{ title }}
                </div>
                <div class="card-body">
                    <div>
                        <form>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="codigo">Código</label>
                                        <input type="text" class="form-control" id="codigo" x-model="form.codigo" required="required">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="titulo">Título</label>
                                        <input type="text" class="form-control" id="titulo" x-model="form.titulo" required="required">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="dataPublicacao">Data de Publicação</label>
                                        <input type="date" class="form-control" id="dataPublicacao" x-model="form.dataPublicacao">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="genero">Gênero</label>
                                        <input type="text" class="form-control" id="genero" x-model="form.genero">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="valor">Valor</label>
                                        <input type="number" step="0.01" class="form-control" id="valor" x-model="form.valor">
                                    </div>
                                </div>
                            </div>
                            <button type="button" @click="insertForm()" class="btn btn-primary mt-4">Salvar</button>
                            <a href="/livro/manutLivro" class="btn btn-info mt-4 ml-2" role="button" aria-disabled="true">Retornar</a>
                        </form>
                        <div class="mt-3">
                            <template x-if="message">
                                <div :class="messageClass" x-text="message"></div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            window.onload = function () {
                windowOnLoad();
                const localErro = "{{ erro }}";
                if (localErro != "") {
                    alert("[vwLivros|onload] Servidor retornou o erro: " + localErro);
                }
                $("#codigo").focus();
            };

            function livroForm() {
                return {
                    form: {
                        codigo: '',
                        titulo: '',
                        dataPublicacao: '',
                        genero: '',
                        valor: '',
                        deleted: false
                    },
                    message: '',
                    messageClass: '',
                    async insertForm() {
                        try {
                            console.log("Valor na página:", JSON.stringify(this.form))
                            const response = await fetch('/livro/insertLivro', {
                                method: 'POST',
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify(this.form)
                            });
                            const result = await response.json();
                            console.log("Valor na response:", response);
                            console.log("Valor na result:", result);
                            if (result.status == "ok") {
                                alert("Livro cadastrado com sucesso");
                                this.resetForm();
                            } else {
                                const errorData = result.status;
                                this.message = `Erro! Não foi possível cadastrar o livro devido ao erro: ${errorData}`;
                                this.messageClass = 'alert alert-danger';
                            }
                        } catch (error) {
                            this.message = `Erro de conexão: ${error.message}`;
                            this.messageClass = 'alert alert-danger';
                        }
                    },
                    resetForm() {
                        this.form = {
                            codigo: '',
                            titulo: '',
                            dataPublicacao: '',
                            genero: '',
                            valor: '',
                            deleted: false
                        };
                        this.message = false;
                    }
                };
            }
        </script>
    </div>
{% endblock %}

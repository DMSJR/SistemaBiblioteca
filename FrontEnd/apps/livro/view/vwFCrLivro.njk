{% extends "templates/base.html" %}

{% block content %}
<div x-data="livroForm()">
    <ol class="breadcrumb mb-2">
        <li class="breadcrumb-item active">{{ title }}</li>
    </ol>
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    Cadastro de Livro
                </div>
                <div class="card-body">
                    <form>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="codigo">Código</label>
                                    <input type="text" class="form-control" id="codigo" x-model="form.codigo" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="titulo">Título</label>
                                    <input type="text" class="form-control" id="titulo" x-model="form.titulo">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="data_publicacao">Data de Publicação</label>
                                    <input type="date" class="form-control" id="data_publicacao" x-model="form.data_publicacao">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="genero">Gênero</label>
                                    <input type="text" class="form-control" id="genero" x-model="form.genero">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="valor">Valor</label>
                                    <input type="number" class="form-control" id="valor" x-model="form.valor" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-start mt-4">
                            <button type="button" @click="insertForm()" class="btn btn-primary">Salvar</button>
                            <a href="/livro/manutLivro" class="btn btn-info ml-2" role="button">Retornar</a>
                        </div>
                    </form>
                    <div class="mt-3">
                        <template x-if="message">
                            <div :class="messageClass" x-text="message"></div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    window.onload = function () {
        const localErro = "{{ erro }}";
        if (localErro && localErro.trim() !== "") {
            alert("[vwLivro|onload] Servidor retornou o erro: " + localErro);
        }
        document.getElementById("codigo").focus();
    };

    function livroForm() {
        return {
            form: {
                codigo: '',
                titulo: '',
                data_publicacao: '',
                genero: '',
                valor: '',
                deleted: false
            },
            message: '',
            messageClass: '',
            async insertForm() {
                try {
                    console.log("Valor na página:", JSON.stringify(this.form));
                    const response = await fetch('/livro/InsertLivro', {
                        method: 'POST',
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(this.form)
                    });
                    const result = await response.json();

                    if (result.status === "ok") {
                        alert("Livro cadastrado com sucesso!");
                        this.resetForm();
                    } else {
                        const errorData = result.status;
                        this.message = `Erro! Não foi possível cadastrar o livro devido ao erro: ${errorData}`;
                        this.messageClass = 'alert alert-danger';
                    }
                } catch (error) {
                    this.message = `Erro de conexão: ${error.message}`;
                    this.messageClass = 'alert alert-danger';
                }
            },
            resetForm() {
                this.form = {
                    codigo: '',
                    titulo: '',
                    data_publicacao: '',
                    genero: '',
                    valor: '',
                    deleted: false
                };
                this.message = '';
                this.messageClass = '';
            }
        };
    }
</script>
{% endblock %}
